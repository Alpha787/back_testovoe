# Мини-CRM для распределения лидов между операторами

Система автоматического распределения обращений лидов между операторами с учетом весов и лимитов нагрузки.

## Технологический стек

- **Python 3.12**
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с БД
- **SQLite** - база данных (файл `crm.db`)

## Установка и запуск

```bash
# Установка зависимостей
pipenv install
# или
pip install fastapi[standard] sqlalchemy uvicorn

# Запуск сервера
uvicorn app.main:app --reload
```

Сервер запустится на `http://127.0.0.1:8000`

**Документация API**: http://127.0.0.1:8000/docs

## Модель данных

- **Operator** - оператор (имя, активность, лимит нагрузки)
- **Lead** - лид (определяется по `external_id` - телефон, email, ID из бота)
- **Source** - источник/бот (название, уникальный код)
- **Contact** - обращение (связывает лида, источник и оператора)
- **OperatorSourceWeight** - вес оператора по источнику для распределения трафика

**Связи**: Оператор ↔ Источник (many-to-many с весами), Лид → Обращения, Источник → Обращения, Оператор → Обращения

## Алгоритм распределения

При создании нового обращения система:

1. **Определяет лида** - ищет по `external_id` или создает нового
2. **Находит доступных операторов** для источника:
   - Оператор активен (`is_active = True`)
   - Текущая нагрузка < лимита (нагрузка = количество активных контактов)
3. **Выбирает оператора по весам** (вероятностный выбор):
   - Вычисляет сумму весов доступных операторов
   - Генерирует случайное число от 0 до суммы весов
   - Выбирает оператора, в диапазон веса которого попало число
   - Пример: вес 10 и 30 → примерно 25% и 75% трафика
4. **Создает обращение** - с оператором или без (если подходящих нет)

**Защита от race condition**: перед финальным выбором система повторно проверяет лимиты нагрузки.

## API эндпоинты

- **Операторы**: `POST/GET/PATCH /api/operators`
- **Источники**: `POST/GET /api/sources`, `POST/GET /api/sources/{id}/operators` (настройка весов)
- **Обращения**: `POST /api/contacts` (автоматическое распределение), `GET /api/contacts`
- **Лиды**: `GET /api/leads`

## Пример использования

```bash
# 1. Создание операторов
curl -X POST "http://127.0.0.1:8000/api/operators" \
  -H "Content-Type: application/json" \
  -d '{"name": "Оператор 1", "is_active": true, "max_load": 10}'

# 2. Создание источника
curl -X POST "http://127.0.0.1:8000/api/sources" \
  -H "Content-Type: application/json" \
  -d '{"name": "Telegram бот", "code": "bot_telegram"}'

# 3. Настройка распределения (веса: 10 и 30 → 25% и 75%)
curl -X POST "http://127.0.0.1:8000/api/sources/1/operators" \
  -H "Content-Type: application/json" \
  -d '{"operator_weights": [{"operator_id": 1, "weight": 10}, {"operator_id": 2, "weight": 30}]}'

# 4. Регистрация обращения (автоматическое распределение)
curl -X POST "http://127.0.0.1:8000/api/contacts" \
  -H "Content-Type: application/json" \
  -d '{"external_id": "user_123", "source_code": "bot_telegram"}'
```

## Важные детали

- **Определение лида**: по уникальному `external_id` (телефон, email, ID из бота). Один лид может обращаться из разных источников.
- **Если операторов нет**: создается обращение без оператора (`operator_id = None`), можно переназначить позже.
- **База данных**: SQLite создается автоматически в `crm.db` при первом запуске.
